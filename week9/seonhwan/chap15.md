# 개략적 설계안 제시 및 동의 구하기
## API
#### 파일 업로드 API
- 단순 업로드
- 이어 올리기
	- 인자
		- uploadType
		- data
	- 절차
		- URL을 받기 위한 최초 요청 전송
		- 데이터를 업로드하고 업로드 상태 모니터링
		- 업로드에 장애 발생 시 장애 발생 시점부터 업로드 재시작
#### 파일 다운로드 API
- 인자
	- path : 다운로드할 파일의 경로
#### 파일 갱신 히스토리 API
- 인자
	- path : 갱신 히스토리 가져올 파일 경로
	- limit : 히스토리 길이의 최대치
## 한대 서버의 제약 극복
![](./images/Pasted%20image%2020260112181134.png)
- 샤딩을 통해 여러 서버에 나누어 저장하여 한대 서버의 제약을 극복한다.
- 그러나 서버에 장애 발생 시 데이터를 잃을 수 있다
S3서비스
- 다중화 지원
- 여러 지역에 걸쳐 다중화를 하여 데이터 손실을 막고 가용성을 최대한 보장할 수 있다.
![](./images/Pasted%20image%2020260112181253.png)
- 로드 밸런서
	- 네트워크 트래픽 분산을 위해 사용
	- 특정 웹 서버 장애 발생 시 자동으로 해당 서버 우회
- 웹 서버
	- 더 많은 웹서버를 추가할 수 있다
	- 이를 통해 대량 트래픽을 쉽게 대응이 가능하다.
- 메타데이터 데이터베이스
	- 파일저장 서버에 분리하여 단일 장애지점을 회피한다.
	- 다중화와 샤딩을 이용하여 가용성과 규모 확장성에 대응한다.
- 파일 저장소
	- S3를 사용하고 가용성과 데이터 무손실을 보장하기 위해 두 개 이상의 지역에 데이터를 다중화한다.
![](./images/Pasted%20image%2020260112181501.png)
## 동기화 충돌
- 두 명 이상의 사용자가 같은 파일이나 폴더를 동시 업데이트 하는 경우 충돌이 발생한다.
- 충돌 발생 시 같은 파일의 두 가지 버전이 존재하게 된다.
- 이 두 버전을 하나로 합칠지, 둘 중 하나를 다른 파일로 대체할지 결정해야한다.
### 개략적 설계안
![](./images/Pasted%20image%2020260112181658.png)
- 사용자 단말 : 사용자가 이용하는 웹브라우저나 모바일 앱 등의 클라이언트
- 블록 저장소 서버
	- 파일 블록을 클라우드 저장소에 업로드하는 서버
	- 클라우드 환경에서 데이터 파일을 저장하는 기술
	- 각 블록에 고유 해시값이 할당되며, 이 해시값을 메타데이터 데이터베이스에 저장
	- 각 블록은 독립적인 객체로 취급되며 클라우드 저장소 시스템에 보관
- 클라우드 저장소 : 파일을 블록단위로 나눠 클라우드 저장소에 보관
- 아카이빙 저장소 : 오랫동안 사용하지 않은 비활성 데이터를 저장하기 위한 시스템
- 로드밸런서 : 요청을 모든 API 서버에 고르게 분산
- API 서버
	- 파일 업로드 외 거의 모든 것을 담당
	- 사용자 인증, 사용자 프로파일 관리, 파일 메타데이터 갱신 등에 사용
- 메타데이터 데이터베이스
	- 사용자, 파일, 블록, 버전 등의 메타데이터 정보를 관리
	- 파일은 클라우드에 보관
- 메타데이터 캐시 : 성능을 높이기 위해 자주 쓰이는 메다데이터 캐시
- 알림 서비스
	- 이벤트가 발생한 경우 클라이언트에게 알리는데 쓰이는 발생/구독 프로토콜 기반 시스템
- 오프라인 사용자 백업 큐 : 클라이언트가 접속 중이 아니라 파일의 최신 상태를 확인할 수 없을 때 해당 정보를 큐에 두어 나중에 접속 시 동기화할 수 있도록 함
# 상세 설계
## 블록 저장소 서버
- 델타 동기화
	- 파일 수정 시 전체 파일 수정 대신 수정이 일어난 블록만 동기화
- 압축
	- 블록 단위로 압축하여 데이터 크기 감소
	- 텍스트 파일은 gzip, bzip2, 이미지, 비디오는 다른 압축 알고리즘 사용
![](./images/Pasted%20image%2020260112190011.png)
새 파일이 추가되는 경우 블록 저장소 서버는 아래와 같이 동작한다.
- 주어진 파일을 작은 블록으로 분할
- 각 블록 압축
- 클라우드 저장소로 보내기 전에 암호화
- 클라우드 저장소로 보내기
델타 동기화는 아래와 같이 동작한다.
![](./images/Pasted%20image%2020260112190052.png)
## 높은 일관성 요구사항
메모리 캐시는 결과적 일관성 모델을 지원한다.
- 캐시에 보관된 사본과 데이터베이스에 있는 원본을 일치
- 데이터베이스에 보관된 원본에 변경이 발생 시 캐시에 있는 사본을 무효화
NoSQL의 경우 ACID를 지원하지 않아 동기화 로직 안에 프로그램해 넣어야한다.
## 메타데이터 데이터베이스
![](./images/Pasted%20image%2020260112191214.png)
## 업로드 절차
![](./images/Pasted%20image%2020260112222137.png)
- 파일 메타데이터 추가
	- 클라이언트1이 새 파일의 메타데이터 추가하기 위한 요청 전송
	- 새 파일의 메타데이터를 데이터베이스에 저장하고 업로드 상태를 대기 중으로 변경
	- 새 파일이 추가되었음을 알림 서비스에 통지
	- 알림 서비스가 관련 클라이언트에게 파일이 업로드되고 있음을 알림
- 파일을 클라우드 저장소에 업로드
	- 파일을 블록 저장소 서버에 업로드
	- 블록저장소 서버가 파일을 블록단위로 쪼개 압축 및 암호화하여 클라우드 저장소에 전송
	- 업로드 완료 시 스토리지에서 완료 콜백 호출하여 api로 전송
	- 메타데이터 DB에 기록된 해당 파일의 상태를 완료로 변경
	- 알림 서비스에 파일 업로드가 끝났음을 통지
	- 알림 서비스 관련 클라이언트에게 파일 업로드가 끝났음을 알림
## 다운로드 절차
![](./images/Pasted%20image%2020260112222252.png)
- 클라이언트 A가 접속중인 상태에서 다른 클라이언트가 파일 변경을 한 경우 알림 서비스를 이용하여 변경 발생을 알림
- A가 네트워크에 연결된 상태가 아닌 경우 데이터가 캐시에 보관. 후에 접속중으로 바뀐 경우 새 버전을 가져가게됨
## 알림 서비스
- 웹소켓
	- 클라이언트와 서버 사이에 지속적인 통신 채널을 제공하여 양방향 통신 가능
- 롱폴링
	- 드롭박스가 채택한 방식
	- 현재 서비스는 양방향 통신이 필요 없다.
	- 알림을 보낼 일이 많지 않고, 알림을 보내야 하는 경우에도 단시간 많은 양의 데이터를 보낼 일이 없다.
	- 따라서 현재 서비스에서는 롱폴링 방식 채택
	- 알림 서버와 롱 폴링용 연결을 유지하다, 변경 감지 시 연결을 끊고 클라이언트가 메타데이터 서버와 연결해 최신 내역을 다운받게 된다.
## 저장소 공간 절약
- 중복 제거
	- 중복된 파일 블록을 제거하는 방법
	- 해시값을 사용한다.
- 지능적 백업 전략
	- 한도 설정
		- 보관할 파일 버전 개수에 상한
		- 제일 오래된 버전을 버린다.
	- 중요한 버전만 보관
	- 자주 쓰이지 않는 데이터를 아카이빙 저장소로 옮기기
## 장애 처리
- 로드밸런서 장애
	- 장애 발생 시 부 로드밸런서가 활성화되어 트래픽을 이어간다.
	- 일정 시간 박동 신호에 응답하지 않는 경우 장애가 발생한 것으로 간주
- 블록 저장소 서버 장애
	- 다른 서버가 미완료 상태 혹은 대기 상태인 작업을 이어받아야 한다.
- 클라우드 저장소 장애
	- S3 버킷이 여러 지역에 다중화할 수 있어, 한 지역에 장애 발생 시 다른 지역에 파일을 가져온다
- API 서버 장애
	- 로드밸런서가 API 서버 장애 발생 시 트래픽을 우회하여 장애 서버를 격리한다.
- 메타데이터 캐시 장애
	- 캐시 서버를 다중화하여 한 노드에 장애가 생길 시 다른 노드에서 데이터를 가져온다.
- 메타데이터 데이터베이스 장애
	- 주 데이터베이스 서버 장애 : 부 데이터베이스 서버 중 하나를 주 데이터베이스 서버로 바꾸고 부 데이터베이스 서버를 하나 추가한다.
	- 부 데이터베이스 서버 장애 : 다른 부 데이터베이스 서버가 읽기 연산을 처리하도록 하고 그동안 장애 서버를 새 것으로 교체한다.
- 알림 서비스 장애
	- 접속 중인 모든 사용자가 알림 서버와 롱 폴링 연결을 하나씩 유지
	- 많은 사용자와 연결을 유지 및 관리
	- 복구는 느릴 수 있다.
- 오프라인 사용자 백업 큐 장애
	- 큐에 장애 발생 시 구독중인 클라이언트들이 백업 큐로 구독 관계 재설정

