# 11장 뉴스 피드 시스템 설계
## 3단계 상세 설계
### 피드 발행 흐름 상세 설계
- 포스팅 전송 서비스
	- 쓰기시점 팬아웃(푸시 모델)
		- 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신
		- 장점
			- 뉴스 피드 실시간 갱신
			- 친구 목록 사용자에게 즉시 전송
			- 뉴스 피드를 읽는 데 드는 시간이 짧아진다.
		- 단점
			- 친구가 많은 사용자의 경우 목록에 있는 사용자 모두의 뉴스 피드를 갱신하는데 많은 시간 소요(핫키 문제)
			- 서비스 자주 이용하지 않는 사용자의 피드도 갱신
	- 읽기 시점 팬아웃(풀 모델)
		- 사용자가 본인 홈페이지나 타임라인을 로딩하는 시점에 새로운 포스트를 가져온다.
		- 장점
			- 비활성화, 거의 로그인하지 않는 사용자의 경우 이 모델이 유리
			- 데이터를 친구 각각에 푸시하지 않아도 되어 핫키 문제 해결
		- 단점
			- 뉴스 피드 읽는데 많은 시간 소요
	- 대부분의 사용자에게는 푸시모델을 사용하며, 친구가 많은 사용자의 경우 풀 모델을 사용하여 시스템 과부하를 방지한다.
	![](./images/Pasted%20image%2020251229210247.png)
### 피드 읽기 흐름 상세 설계
![](./images/Pasted%20image%2020251229210606.png)
### 캐시 구조
![](./images/Pasted%20image%2020251229210942.png)

# 12장 채팅 시스템 설계
## 개략적 설계안 제시 및 동의 구하기
- 폴링
	- 클라이언트가 주기적으로 서버에 새 메시지가 있는지 물어보는 방법
	- 폴링을 자주 할수록 폴링 비용이 올라간다.
	![](./images/Pasted%20image%2020251229211855.png)
- 롱 폴링
	- 클라이언트가 새 메시지가 반환되거나 타임아웃 될 때까지 연결을 유지한다.
	- 메시지 보내는 클라이언트와 수신하는 클라이언트가 같은 채팅 서버에 접속하게 되지 않을 수 있다.
	- 서버 입장에서 클라이언트가 연결을 해제했는지 알 수 있는 방법이 없다.
	![](./images/Pasted%20image%2020251229212006.png)
- 웹소켓
	![](./images/Pasted%20image%2020251229212235.png)
	- 클라이언트가 연결을 하면 양방향 통신을 하게 된다.
	- 방화벽이 있는 환경에서도 잘 동작하며 비동기적으로 메시지를 전송한다.
### 개략적 설계안
- 무상태 서비스
	- 로그인, 회원가입, 사용자 프로파일 표시 등을 처리하는 요청/응답 서비스
	- 이는 로드밸런서 뒤에 위치한다.
	![](./images/Pasted%20image%2020251229212441.png)
- 상태 유지 서비스
	- 채팅서비스가 이에 속한다.
	- 각 클라이언트가 채팅 서버와 독립적인 네트워크 연결을 유지해야 한다.
- 제3자 서비스 연동
	- 푸시 알림이 이에 속한다.
- 규모 확장성
	![](./images/Pasted%20image%2020251229212651.png)
- 저장소
	- 채팅은 키-값 저장소가 적절하다.
		- 수평적 규모 확장의 용이성
		- 데이터 접근 지연 시간 감소
- 메시지 ID
	- 스노플레이크와 같은 64bit 순서번호 생성기 이용
	- 지역적 순서 번호 생성기를 이용
## 상세 설계
- 서비스 탐색
	![](./images/Pasted%20image%2020251229224027.png)
- 메시지 흐름
	- 1:1 채팅 메시지 처리 흐름
	![](./images/Pasted%20image%2020251229224123.png)
	- 여러 단말 사이에 메시지 동기화
	![](./images/Pasted%20image%2020251229224201.png)
	- 아래 두 조건을 만족하는 경우 새 메시지로 간주한다.
		- 수신자 ID가 현재 로그인한 사용자 ID와 같다.
		- 키-값 저장소에 보관된 메시지로서, 그 ID가 cur_max_message_id보다 크다.
- 소규모 그룹 채팅에서의 메시지 흐름
	![](./images/Pasted%20image%2020251229224750.png)
	- 메시지 동기화 플로우가 단순하다
	- 그룹이 크지 않은 경우 메시지를 수신자 별로 복사해서 큐에 넣는 작업의 비용이 문제가 되지 않는다.
	- 많은 사용자를 지원하는 경우 똑같은 메시지를 모든 사용자의 큐에 복사하는 것은 바람직하지 않다. 따라서 아래와 같이 변경하여 여러 사용자로부터 오는 메시지를 받을 수 있도록 한다.
	![](./images/Pasted%20image%2020251229224909.png)
### 접속상태 표시
- 사용자 로그인
	- 웹소켓 연결을 하고 사용자의 상태와 last_active_at 타임스탬프 값을 키-값 저장소에 보관한다
- 로그아웃
	- 로그아웃 후 사용자 상태를 접속 중이 아닌 것으로 변경한다.
- 접속 장애
	- 박동 검사를 사용하여 문제를 해결한다.
	- 주기적으로 박동 이벤트를 보내고 마지막 이벤트를 받은 지 x초 이내에 또 다른 박동 이벤트 메시지를 받을 온라인 상태로 유지한다.
- 상태 정보의 전송
	- 상태정보 서버는 pub-sub 구조를 사용한다.
	![](./images/Pasted%20image%2020251229230216.png)
	